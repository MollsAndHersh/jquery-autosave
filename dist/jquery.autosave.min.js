/**
 * @fileOverview jQuery.autosave
 *
 * @author Kyle Florence
 * @website https://github.com/kflorence/jquery-autosave
 * @version 1.0.20110421
 *
 * Inspired by the jQuery.autosave plugin written by Raymond Julin,
 * Mads Erik Forberg and Simen Graaten.
 *
 * Dual licensed under the MIT and BSD Licenses.
 */
(function(a,b,c,d){var e=function(d,e,f){var g=a(d),h=/^(checked|selectedIndex)$/,i="onpropertychange"in c.body;if(!g.length||typeof e!="string")return g;if(e!=="change")return g.bind(e,f);g.each(function(){e=i&&(this.type==="checkbox"||this.tagName.toLowerCase()==="select"&&this.multiple)?"propertychange":"change",a(this).bind(e,function(a){(a.type!=="propertychange"||h.test(b.event.propertyName))&&f.call(this,a)})})},f=function(b,c){var d={},e=typeof b;e==="function"?d.method=b:e==="string"&&b in c?d=c[b]:e==="object"&&(e=typeof b.method,e==="function"?d=b:e==="string"&&b.method in c&&(d=c[b.method]),typeof d.options=="object"?d.options=a.extend(!0,{},d.options,b.options):d.options={});return d};a.autosave={timer:0,$queues:a({}),options:{namespace:"autosave",callbacks:{trigger:"change",scope:null,data:null,condition:null,save:"ajax"},events:{save:"save",saved:"saved",changed:"changed"},classes:{changed:"changed",ignore:"ignore"}},initialize:function(b,d){var g=this;a.extend(this,{context:b.context||c,selector:b.selector||b,options:a.extend(!0,{},this.options,d)});if(this.elements().length){var h,i=this.forms(),j=this.inputs();i.data(this.options.namespace,this),a.each(this.options.events,function(a,b){g.options.events[a]=[b,g.options.namespace].join(".")}),a.each(this.options.classes,function(a,b){g.options.classes[a]=[g.options.namespace,b].join("-")}),a.each(this.options.callbacks,function(b,c){h=[],c&&a.each(a.isArray(c)?c:[c],function(c,d){d=f(d,g.callbacks[b]),a.isFunction(d.method)&&h.push(d)}),g.options.callbacks[b]=h}),e(i,this.options.events.save,function(a,b){g.save(b,a.type)}),e(j,"change",function(b){a(this).addClass(g.options.classes.changed),a(this.form).triggerHandler(g.options.events.changed,[this])}),a.each(this.options.callbacks.trigger,function(a,b){b.method.call(g,b.options)})}return b},elements:function(b,c){b=b||this.selector,c=c||this.context;return a(b,c).filter(function(){return this.elements||this.form})},forms:function(b){return a(a.unique(this.elements(b).map(function(){return this.elements?this:this.form}).get()))},inputs:function(b){return this.elements(b).map(function(){return this.elements?a.makeArray(this.elements):this})},validInputs:function(b){var c=this;return this.inputs(b).filter(function(){return!a(this).hasClass(c.options.classes.ignore)})},changedInputs:function(b){var c=this;return this.inputs(b).filter(function(){return a(this).hasClass(c.options.classes.changed)})},startInterval:function(a){var b=this;a=a||this.interval,this.timer&&this.stopInterval(),isNaN(parseInt(a))||(this.timer=setTimeout(function(){b.save(!1,b.timer)},a))},stopInterval:function(){clearTimeout(this.timer),this.timer=null},save:function(b,c){var d=this,e=!1,f=this.validInputs(b);if(this.options.callbacks.save.length){a.each(this.options.callbacks.scope,function(a,b){f=b.method.call(d,b.options,f)});if(f.length){var g=!0,h=f.serializeArray();a.each(this.options.callbacks.data,function(a,b){h=b.method.call(d,b.options,f,h)}),a.each(this.options.callbacks.condition,function(a,b){return(g=b.method.call(d,b.options,f,h,c))!==!1}),g&&(a.each(this.options.callbacks.save,function(a,b){d.$queues.queue("save",function(){b.method.call(d,b.options,h)!==!1&&d.next("save")})}),e=!0)}}this.next("save",e)},next:function(a,b){var c=this.$queues.queue(a);c&&c.length?this.$queues.dequeue(a):this.finished(c,a,b)},finished:function(a,b,c){b==="save"&&(a&&this.forms().triggerHandler(this.options.events.saved),c!==!1&&this.changedInputs().removeClass(this.options.classes.changed),this.timer&&this.startInterval())}};var g=a.autosave.callbacks={};a.each(a.autosave.options.callbacks,function(a){g[a]={}}),a.extend(g.trigger,{change:{method:function(){var a=this;this.forms().bind(this.options.events.changed,function(b,c){a.save(c,b.type)})}},interval:{method:function(a){isNaN(parseInt(a.interval))||this.startInterval(this.interval=a.interval)},options:{interval:3e4}}}),a.extend(g.scope,{all:{method:function(){return this.validInputs()}},changed:{method:function(){return this.changedInputs()}}}),a.extend(g.data,{serializeObject:{method:function(b,c){var e={};a.each(c.serializeArray(),function(b,c){var f=c.name,g=c.value;e[f]=e[f]===d?g:a.isArray(e[f])?e[f].concat(g):[e[f],g]});return e}}}),a.extend(g.condition,{interval:{method:function(a,b,c,d){return!this.timer||this.timer===d}},changed:{method:function(){return this.changedInputs().length>0}}}),a.extend(g.save,{ajax:{method:function(b,c){var d=this;a.ajax(a.extend(!0,{data:c},b,{complete:function(c,e){a.isFunction(b.complete)&&b.complete.apply(d,arguments),d.next("save")}}));return!1},options:{url:b.location.href,type:"POST"}}}),a.fn.autosave=function(b){return a.extend({},a.autosave).initialize(this,b)}})(jQuery,window,document);
